{% extends 'README_MASTER.jt2' %}


{% block TOC %}
## Contents
- [Introduction](#introduction)
- [Prerequisites](#prerequisites)
- [Security](#security)
- [Deploying the Template](#deploying-the-template)
- [Configuration Example](#config)
- [Service Discovery](#service-discovery)
{% endblock TOC %}

{% block intro %}
## Introduction

This solution uses a Google Deployment Manager (GDM) Template to launch two BIG-IP VEs in an Active/Standby configuration with network failover enabled (the template also supports [multiple traffic groups](#traffic-group-configuration) which enables Active/Active deployments) in a Google Virtual Private Cloud, using BYOL (bring your own license) licensing.

This is a *production stack* template, meaning it deploys without creating or attaching any public IP addresses to the BIG-IP VEs (note that outbound Internet access for the BIG-IP is still required). This can be useful, or possibly required, where dictated by security policy or in deployments where accessing resources does not require a public IP address on the BIG-IP VE, such as users connecting to internal applications using a VPN.  See the *existing stack* directory if you do not need this production stack template.

Traffic flows from the BIG-IP VE(s) to the application servers. Each BIG-IP VE has 3 network interfaces (NICs), one for management, one for external traffic, and one for internal traffic.

The BIG-IP VE has the [Local Traffic Manager](https://f5.com/products/big-ip/local-traffic-manager-ltm) (LTM) module enabled to provide advanced traffic management functionality. This means you can also configure the BIG-IP VE to enable F5's L4/L7 security features, access control, and intelligent traffic management.
{% endblock intro %}
{% block prereq %}
## Prerequisites

The following are prerequisites for this F5 GDM template:

- You must have installed the [Google Cloud SDK](https://cloud.google.com/sdk/downloads)
- An F5 Networks BYOL license (Bring Your Own License) available.
- Three Google Cloud Platform (GCP) networks with at least one subnet in each. The subnet for the management network requires a route and access to the Internet for the initial configuration to download the BIG-IP cloud library.
- Key pair for SSH access to BIG-IP VE (you can create or import this in Google Cloud)
- A Google Firewall rule with the following inbound rules:
  - Port 22 for SSH access to the BIG-IP VE
  - Port 443 (or alternate port) for accessing the BIG-IP web-based Configuration utility
  - A port for accessing your applications via the BIG-IP virtual server
- This solution uses the SSH key to enable access to the BIG-IP system. If you want access to the BIG-IP web-based Configuration utility, you must first SSH into the BIG-IP VE using the SSH key you provided in the template.  You can then create a user account with admin-level permissions on the BIG-IP VE to allow access if necessary.
- You must use a BIG-IP instance that has at least 4 vCPU and 8 GB memory. For each additional vCPU, add at least 2 GB of memory.
- **Important**: For this 3 NIC template, you MUST use a machine type of at least **n1-standard-4**.  See this [link](https://cloud.google.com/vpc/docs/create-use-multiple-interfaces#max-interfaces) for more information about required vCPUs and interfaces.  Note: Because of this requirement, the *n1-highcpu* instance types are not supported.
- **Important**: For this production stack template, the management and external interfaces must be able to communicate with the internet.  This may be done using a [NAT gateway](https://cloud.google.com/solutions/connecting-securely#natgateway).  Note: This stack type means the BIG-IP VE(s) do not have any public IP's attached to the interfaces which requires alternate means to talk to external services, including GCP API's.
{% endblock prereq %}
{% block info %}
## Important configuration notes

- Beginning with release 1.5.0, the BIG-IP image names have changed (previous options were Good, Better, and Best).  Now you choose a BIG-IP VE image based on whether you need [LTM](https://www.f5.com/products/big-ip-services/local-traffic-manager) only or All modules available (including [WAF](https://www.f5.com/products/security/advanced-waf), [AFM](https://www.f5.com/products/security/advanced-firewall-manager), etc.), and if you need 1 or 2 boot locations.  Use 2 boot locations if you expect to upgrade the BIG-IP VE in the future. If you do not need room to upgrade (if you intend to create a new instance when a new version of BIG-IP VE is released), use an image with 1 boot location.
- This template supports service discovery.  See the [Service Discovery section](#service-discovery) for details.
- F5 has created a matrix that contains all of the tagged releases of the F5 Google GDM templates, and the corresponding BIG-IP versions, license types and throughput levels available for a specific tagged release. See the matrix [here](https://github.com/F5Networks/f5-google-gdm-templates/blob/master/google-bigip-version-matrix.md).
- In order to pass traffic from your clients to the servers, after launching the template, you must create virtual server(s) on the BIG-IP VE.  See [Creating a virtual server](#creating-virtual-servers-on-the-big-ip-ve).
- This template supports associating GCP alias IPs with up to two BIG-IP traffic groups, allowing each BIG-IP VE device to process traffic for applications associated with the traffic group for which the device is active.  See [Traffic Group Configuration](#traffic-group-configuration) for instructions.

### Security

This GDM template downloads helper code to configure the BIG-IP system. If you want to verify the integrity of the template, you can open the GDM template and ensure the following lines are present. See [Security Detail](#securitydetail) for the exact code in each of the following sections.

- In the */config/verifyHash* section: **script-signature** and then a hashed signature

Additionally, F5 provides checksums for all of our supported Google Deployment Manager templates. For instructions and the checksums to compare against, see this [link](https://devcentral.f5.com/codeshare/checksums-for-f5-supported-cft-and-arm-templates-on-github-1014).

{% include 'HELP_EXPERIMENTAL.jt2' with context %}

## Deploying the template

This solution uses a YAML file for containing the parameters necessary to deploy the BIG-IP instance in Google Cloud.

- [**f5-deployment-template.yaml**](https://github.com/F5Networks/f5-google-gdm-templates/blob/master/experimental/failover/same-net/via-api/3nic/production-stack/byol/f5-deployment-template.yaml)

You ***must edit the YAML file*** to include information for your deployment before using the file to launch the BIG-IP VE instance.

1. Make sure you have completed all of the [prerequisites](#prerequisites).
2. [Edit the parameters](#edit-the-yaml-file) in the YAML file in this repository as described in this section.
3. [Save the YAML and Python files](#save-the-yaml-and-python-files).
4. [Deploy the BIG-IP VE](#deploy-the-big-ip-ve) from the command line.

### Edit the YAML file

After completing the prerequisites, edit the YAML file.  You must replace the following parameters with the appropriate values. For more information about the Service Discovery fields, see [Service Discovery section](#service-discovery).

| Parameter | Required | Description |
| --- | --- | --- |
| region | Yes | The Google region in which you want to deploy BIG-IP, for example **us-west1** |
| availabilityZone1 | Yes | The availability zone where you want to deploy the BIG-IP VE instance, for example **us-west1-a** |
| mgmtNetwork | Yes | Name of the network you want to use for management traffic |
| mgmtSubnet | Yes | Name of the subnet you want to use for management traffic |
| network1 | Yes | Name of the network you want to use for external application traffic |
| subnet1 | Yes | Name of the subnet you want to use for external application traffic |
| mask1 | Yes | Mask for the provided external application traffic subnet, for example **24** |
| aliasIp | Yes | Alias IP address(es) to be used for application traffic, including CIDR suffix. The address(es) must belong to the subnet noted above in key 'subnet1'. A list of alias IPs can be provided, separated by a semi-colon for example **10.x.x.16/28;10.x.x.32/28** |
| network2 | Yes | Name of the network you want to use for internal application traffic |
| subnet2 | Yes | Name of the subnet you want to use for internal application traffic |
| mask2 | Yes | Mask for the provided internal application traffic subnet, for example **24** |
| licenseKey1 | Yes | Your F5 BIG-IP BYOL license key for the first BIG-IP |
| licenseKey2 | Yes | Your F5 BIG-IP BYOL license key for the second BIG-IP |
| imageName | Yes | BIG-IP image you want to deploy |
| instanceType | Yes | The BIG-IP instance type you want to use, such as **n1-standard-4** |
| mgmtGuiPort | Yes | BIG-IP management port.  The default is **443** |
| serviceAccount | Yes | If using service discovery, enter the Google service account to use for discovery. Leave single quotes with nothing between when not using service discovery |
| tagName | Yes | If using service discovery, enter the tag name used on servers for discovery. Leave single quotes with nothing between if not using service discovery |
| tagValue | Yes | If using service discovery, enter the tag value used on servers for discovery. Leave single quotes with nothing between if not using service discovery |
| allowUsageAnalytics | Yes | This deployment can send anonymous statistics to F5 to help us determine how to improve our solutions. If you select **No** statistics are not sent |

### Save the YAML and Python files

After you have edited the YAML file with the appropriate values, save the YAML file in a location accessible from the gcloud command line.  Save the [python file](f5-deployment-template.py) in the same location.

### Deploy the BIG-IP VE

The final task is to deploy the BIG-IP VE from the **gcloud** command line.  See https://cloud.google.com/sdk/gcloud/reference/deployment-manager/deployments/create for specific information.  

You can either create a new deployment from the [top-level YAML file](#deploying-from-the-yaml-file), or the [top-level template file](#deploying-from-the-template-file).

#### Deploying from the YAML file
To deploy the BIG-IP VE from the top-level YAML file, use the following command syntax:

```gcloud deployment-manager deployments create <your-deployment-name> --config <your-file-name.yaml> --description "<deployment-description>"```

Keep in mind the following:

- *your-deployment-name*<br>This name must be unique.<br>
- *your-file-name.yaml*<br>  If your file is not in the same directory as the Google SDK, include the full file path in the command.

#### Deploying from the template file
To deploy the BIG-IP VE from the top-level template file, use the following syntax, and set each property key you are using:

```gcloud deployment-manager deployments create <your-deployment-name>       \
            --template template.{jinja|py}             \
      --properties "string-key:'string-value',integer-key:12345"```


## Configuration Example <a name="config"></a>

The following is a simple configuration diagram for this deployment.

![Configuration example](../images/google_setup.png)

## Creating virtual servers on the BIG-IP VE

In order to pass traffic from your clients to the servers through the BIG-IP system, you must create a virtual server on the BIG-IP VE. To create a BIG-IP virtual server you need to know the IP address to use, which should match (or be within the CIDR range defined) a GCP alias IP configured on the active BIG-IP VE. If you need additional virtual servers for your applications/servers, you can add more alias IP ranges, and corresponding virtual servers on the BIG-IP system. See [gcp-vpc-alias-ips](https://cloud.google.com/vpc/docs/alias-ip) for information on alias IP ranges.

In this template, each IP address is associated with an alias IP range attached to the external network interface of the BIG-IP VE. Because this alias IP will be moved to the active BIG-IP device, you need to create a single virtual server in **traffic-group-1** that corresponds to the IP address of that alias IP.

1. Once your BIG-IP VE has launched, open the BIG-IP VE Configuration utility.
2. On the Main tab, click **Local Traffic > Virtual Servers** and then click the **Create** button.
3. In the **Name** field, give the Virtual Server a unique name.
4. In the **Destination/Mask** field, type the IP address of the alias IP to be associated with your application (for example: 10.0.1.10/32).
5. In the **Service Port** field, type the appropriate port.
6. Configure the rest of the virtual server as appropriate.
7. If you used the Service Discovery iApp template: In the Resources section, from the **Default Pool** list, select the name of the pool created by the iApp.
8. Click the **Finished** button.
9. Repeat as necessary.

When you have completed the virtual server configuration, you may modify the virtual addresses to use an alternative Traffic Group using the following guidance.

1. On the Main tab, click **Local Traffic > Virtual Servers**.
2. On the Menu bar, click the **Virtual Address List** tab.
3. Click the address of one of the virtual servers you just created.
4. From the **Traffic Group** list, select **traffic-group-2** (or the additional traffic group you created previously).
5. Click **Update**.
6. Repeat for each virtual server.

### Traffic Group Configuration

This template supports associating GCP Instance NIC alias IP resources with up to two BIG-IP traffic groups, allowing each BIG-IP VE device to process traffic for applications associated with the traffic group for which the device is active.  Use the following guidance to configure multiple traffic groups.

1. From the BIG-IP VE management Configuration utility, click **Device Management > Traffic Groups > Create**, and then complete the following.
    - *Name*: **traffic-group-2**
    - *Failover Order*: Select the preferred order of the devices for this traffic group; F5 recommends setting the current standby device as the preferred device for this second traffic group, so that each traffic group has a different preferred device (device will become active after creating the traffic group).
    - Click **Create Traffic Group**.
2. Ensure the BIG-IP **Virtual Address** corresponding with the created virtual servers is in the desired traffic group.
    - Note: NIC Alias IPs are mapped to a specific traffic group by the Virtual Address configuration of the BIG-IP.
    - Note: You can find the Virtual Address list by browsing to Local Traffic->Virtual Servers->Virtual Address List.

## Service Discovery

This Google GDM template supports Service Discovery.  If you enable it in the YAML file, the template runs the Service Discovery iApp template on the BIG-IP VE. Once you have properly tagged the servers you want to include, and then entered the corresponding tags (**tagName** and **tagValue**) and Google service account in the YAML file, the BIG-IP VE programmatically discovers (or removes) members using those tags. See our [Service Discovery video](https://www.youtube.com/watch?v=ig_pQ_tqvsI) to see this feature in action.

**Important**: Even if you don't plan on using the Service Discovery iApp initially, if you think you may want to use it in the future, you must specify the Google service account (**serviceAccount**) in the YAML file before deploying the template.

### Tagging

In Google, you tag objects using the **labels** parameter within the virtual machine.  The Service Discovery iApp uses these tags to discover nodes with this tag. Note that you select public or private IP addresses within the iApp.

- *Tag a VM resource*

The BIG-IP VE will discover the primary public or private IP addresses for the primary NIC configured for the tagged VM.


**Important**: Make sure the tags and IP addresses you use are unique. You should not tag multiple GDM nodes with the same key/tag combination if those nodes use the same IP address.


When enabled, the template runs the iApp template automatically.  If you need to modify the template after this initial configuration has taken place, use the following guidance.

1. From the BIG-IP VE web-based Configuration utility, on the Main tab, click **iApps > Application Services**.
2. From the list of application services, click **serviceDiscovery**.
3. You can now modify the template settings as applicable.  For assistance, from the *Do you want to see inline help?* question, select **Yes, show inline help**.
4. When you are done, click the **Finished** button.

If you want to verify the integrity of the template, from the BIG-IP VE Configuration utility click **iApps > Templates**. In the template list, look for **f5.service_discovery**. In the Verification column, you should see **F5 Verified**.


### Documentation

The ***BIG-IP Virtual Edition and Google Cloud Platform: Setup*** [guide](https://support.f5.com/kb/en-us/products/big-ip_ltm/manuals/product/bigip-ve-setup-google-cloud-platform-13-0-0.html) details how to create the configuration manually without using the template.  This document also describes the configuration in more detail.


## Security Details <a name="securitydetail"></a>

This section has the entire code snippet for each of the lines you should ensure are present in your template file if you want to verify the integrity of the helper code in the template.

### /config/verifyHash section

Note the hashes and script-signature may be different in your template. The important thing to check is that there is a script-signature line present in the location.<br>


```python

    'cli script /Common/verifyHash {',
    'proc script::run {} {',
    '        if {[catch {',
    '            set hashes(f5-cloud-libs.tar.gz) a1de46685e31463e6c103078797b90e5f29a4b94702b0522eef2364c3792414067a0bea50c4ed49784c14277a578d8b41f9ac7ba058d9ff72ef687034e5119c6',
    '            set hashes(f5-cloud-libs-aws.tar.gz) d0803e306c01bdf82895c8f30f3b3c2df5f76edbe1875c0ffbfea6864436ece54a73ffd02ccd1b889c324b093897702087b722f10cc7f87994f518f81d7260ea',
    '            set hashes(f5-cloud-libs-azure.tar.gz) a1f264a165b88c03f55d49afb4fdb5f63d80755f1afe947a02e4a36755c7fcec432495417d8084329c6c14e4c426c2e63bab92862afb760d63f584a570b119e6',
    '            set hashes(f5-cloud-libs-gce.tar.gz) c01b25f4d6f48d9ac21b1a6ba3553c978e4fb8ce8655947a307f27e67833c4bebf8b72fef108ea02e11b5e9aa35d33e39db8624b3db34de509d0d79959c754c7',
    '            set hashes(f5-cloud-libs-openstack.tar.gz) 5c83fe6a93a6fceb5a2e8437b5ed8cc9faf4c1621bfc9e6a0779f6c2137b45eab8ae0e7ed745c8cf821b9371245ca29749ca0b7e5663949d77496b8728f4b0f9',
    '            set hashes(asm-policy-linux.tar.gz) 63b5c2a51ca09c43bd89af3773bbab87c71a6e7f6ad9410b229b4e0a1c483d46f1a9fff39d9944041b02ee9260724027414de592e99f4c2475415323e18a72e0',
    '            set hashes(f5.http.v1.2.0rc4.tmpl) 47c19a83ebfc7bd1e9e9c35f3424945ef8694aa437eedd17b6a387788d4db1396fefe445199b497064d76967b0d50238154190ca0bd73941298fc257df4dc034',
    '            set hashes(f5.http.v1.2.0rc6.tmpl) 811b14bffaab5ed0365f0106bb5ce5e4ec22385655ea3ac04de2a39bd9944f51e3714619dae7ca43662c956b5212228858f0592672a2579d4a87769186e2cbfe',
    '            set hashes(f5.http.v1.2.0rc7.tmpl) 21f413342e9a7a281a0f0e1301e745aa86af21a697d2e6fdc21dd279734936631e92f34bf1c2d2504c201f56ccd75c5c13baa2fe7653213689ec3c9e27dff77d',
    '            set hashes(f5.aws_advanced_ha.v1.3.0rc1.tmpl) 9e55149c010c1d395abdae3c3d2cb83ec13d31ed39424695e88680cf3ed5a013d626b326711d3d40ef2df46b72d414b4cb8e4f445ea0738dcbd25c4c843ac39d',
    '            set hashes(f5.aws_advanced_ha.v1.4.0rc1.tmpl) de068455257412a949f1eadccaee8506347e04fd69bfb645001b76f200127668e4a06be2bbb94e10fefc215cfc3665b07945e6d733cbe1a4fa1b88e881590396',
    '            set hashes(f5.aws_advanced_ha.v1.4.0rc2.tmpl) 6ab0bffc426df7d31913f9a474b1a07860435e366b07d77b32064acfb2952c1f207beaed77013a15e44d80d74f3253e7cf9fbbe12a90ec7128de6facd097d68f',
    '            set hashes(f5.aws_advanced_ha.v1.4.0rc3.tmpl) 2f2339b4bc3a23c9cfd42aae2a6de39ba0658366f25985de2ea53410a745f0f18eedc491b20f4a8dba8db48970096e2efdca7b8efffa1a83a78e5aadf218b134',
    '            set hashes(asm-policy.tar.gz) 2d39ec60d006d05d8a1567a1d8aae722419e8b062ad77d6d9a31652971e5e67bc4043d81671ba2a8b12dd229ea46d205144f75374ed4cae58cefa8f9ab6533e6',
    '            set hashes(deploy_waf.sh) 1a3a3c6274ab08a7dc2cb73aedc8d2b2a23cd9e0eb06a2e1534b3632f250f1d897056f219d5b35d3eed1207026e89989f754840fd92969c515ae4d829214fb74',
    '            set hashes(f5.policy_creator.tmpl) 06539e08d115efafe55aa507ecb4e443e83bdb1f5825a9514954ef6ca56d240ed00c7b5d67bd8f67b815ee9dd46451984701d058c89dae2434c89715d375a620',
    '            set hashes(f5.service_discovery.tmpl) 7a4660468dffdc4f6d9aec4c1f9d22abfb3e484e7d6fe6a12fc9ab3eec3819dc34d133aea3cce4fdd87a0f4045069270061f2ea1ee7735922e4371592e498a0b',
    '            set hashes(f5.cloud_logger.v1.0.0.tmpl) a26d5c470e70b821621476bcfd0579dbc0964f6a54158bc6314fa1e2f63b23bf3f3eb43ade5081131c24e08579db2e1e574beb3f8d9789d28acb4f312fad8c3e',
    'NEW_LINE',
    '            set file_path [lindex $tmsh::argv 1]',
    '            set file_name [file tail $file_path]',
    'NEW_LINE',
    '            if {![info exists hashes($file_name)]} {',
    '                tmsh::log err "No hash found for $file_name"',
    '                exit 1',
    '            }',
    'NEW_LINE',
    '            set expected_hash $hashes($file_name)',
    '            set computed_hash [lindex [exec /usr/bin/openssl dgst -r -sha512 $file_path] 0]',
    '            if { $expected_hash eq $computed_hash } {',
    '                exit 0',
    '            }',
    '            tmsh::log err "Hash does not match for $file_path"',
    '            exit 1',
    '        }]} {',
    '            tmsh::log err {Unexpected error in verifyHash}',
    '            exit 1',
    '        }',
    '    }',
    '    script-signature jJpTQ0bcHm9SypZSOPeKaHoUKRdTyLbz80xHYXy39dWx76geCGT5otZi4SdqGBiiwKFydQTqSVu+Uzj8TQZGg2fbxKg/Ks28Ht+nvLoTiNwZGY5o+iPse45QvltBvE+aCOIaw8a5ZBd5ZMF7A8JQpTwttUFRjFgXFu9CncAWOTypov46ve9dzRW8dRPbAImaJSby38jUIVWjv2iB3qZHz//bXjdZ5qUpFvpPH5dGzYN5SoQmUVI3kbiOpZlRJcSj8cKzQ7EsQozile5JkzPrzUeeMgOHihAZcOzgvYWl2LYe9iedixzF7ci6d4YNUuUhFfyrlrUOZSMUPtRzM3+rYQ==',
    '    signing-key /Common/f5-irule',

```

## Filing Issues

If you find an issue, we would love to hear about it.
You have a choice when it comes to filing issues:

- Use the **Issues** link on the GitHub menu bar in this repository for items such as enhancement or feature requests and non-urgent bug fixes. Tell us as much as you can about what you found and how you found it.
- Contact us at [solutionsfeedback@f5.com](mailto:solutionsfeedback@f5.com?subject=GitHub%20Feedback) for general feedback or enhancement requests.
- Use our [Slack channel](https://f5cloudsolutions.herokuapp.com) for discussion and assistance on F5 cloud templates. There are F5 employees who are members of this community who typically monitor the channel Monday-Friday 9-5 PST and will offer best-effort assistance.
- For templates in the **supported** directory, contact F5 Technical support via your typical method for more time sensitive changes and other issues requiring immediate support.
{% endblock %}
{% block warning %}{% endblock warning%}
{% block matrix %}{% endblock matrix %}
{% block special %}{% endblock special %}
{% block supported %}{% endblock supported %}
