{% extends 'README_MASTER.jt2' %}

{% block TOC %}
## Contents

- [Introduction](#introduction)
- [Prerequisites](#prerequisites)
- [Security](#security)
- [Deploying the Template](#deploying-the-template)

{% endblock TOC %}

{% block intro %}
## Introduction

This solution uses a Google Deployment Manager Template to launch a 2 NIC deployment a BIG-IP VE in an Google Virtual Private Cloud, using PAYG (pay as you go) hourly licensing.

This is an *existing stack* template, meaning the networking infrastructure MUST be available prior to deploying. See the Template Parameters Section for required networking objects.

In a 2-NIC implementation, one interface is for management and one is for data-plane traffic, each with a unique public/private IP. Traffic flows from the BIG-IP VE to the application servers.

The BIG-IP VE has the [Local Traffic Manager](https://f5.com/products/big-ip/local-traffic-manager-ltm) (LTM) module enabled to provide advanced traffic management functionality. This means you can also configure the BIG-IP VE to enable F5's L4/L7 security features, access control, and intelligent traffic management.

{% endblock intro %}

{% block prereq %}
## Prerequisites

The following are prerequisites for the F5 2 NIC GDM template:

- You must have installed the [Google Cloud SDK](https://cloud.google.com/sdk/downloads)
- Two Google Cloud Platform (GCP) networks with at least one subnet in each. The subnet for the management network and external traffic (network1/subnet1) requires a route and access to the Internet for the initial configuration to download the BIG-IP cloud library.
- Key pair for SSH access to BIG-IP VE (you can create or import this in Google Cloud).
- This solution uses the SSH key to enable access to the BIG-IP system. If you want access to the BIG-IP web-based Configuration utility, you must first SSH into the BIG-IP VE using the SSH key you provided in the template.  You can then create a user account with admin-level permissions on the BIG-IP VE to allow access if necessary.
- You must use a BIG-IP instance that has at least 2 vCPU and 4 GB memory. For each additional vCPU, add at least 2 GB of memory. Note: Because of this requirement, the *n1-highcpu* instance types are not supported.
{% endblock prereq %}

{% block info %}
## Important configuration notes

- Beginning with release 2.0.0, interface NIC1 is used for management traffic. This will allow the use of specific Google services which require NIC0 be used, such as port forwarding, lb services, etc. Specifically, public/external application traffic now traverses NIC0, and management traffic traverses NIC1.
- This template supports service discovery.  See the [Service Discovery section](#service-discovery) for details.
- F5 has created a matrix that contains all of the tagged releases of the F5 Google GDM templates, and the corresponding BIG-IP versions, license types and throughput levels available for a specific tagged release. See the matrix [here](https://github.com/F5Networks/f5-google-gdm-templates/blob/master/google-bigip-version-matrix.md).
- This template supports accepting static addresses as a parameter to be used during instance creation.  During a lifecycle event, you can explicitly reserve the static address prior to deleting the instance and creating a new one using the same address.  The documentation describing how to do that in more detail is [here](https://cloud.google.com/compute/docs/ip-addresses/reserve-static-internal-ip-address).

{% include 'SECURITY.jt2' with context %}

{% include 'HELP_SUPPORTED.jt2' with context %}


## Deploying the template

This solution uses python script and a YAML file to deploy the BIG-IP VE.  The YAML file contains the parameters necessary to deploy the BIG-IP instance in Google Cloud, and calls the python script to launch the instance.

- PAYG: [**f5-existing-stack-payg-2nic-bigip.yaml**](https://github.com/F5Networks/f5-google-gdm-templates/blob/master/supported/standalone/2nic/existing-stack/payg/f5-existing-stack-payg-2nic-bigip.yaml)

You ***must edit the YAML file*** to include information for your deployment before using the file to launch the BIG-IP VE instance.

1. Make sure you have completed all of the [prerequisites](#prerequisites).
2. [Edit the parameters](#edit-the-yaml-file) in the YAML file in this repository as described in this section.
3. [Save the YAML and Python files](#save-the-yaml-and-python-files).
4. [Deploy the BIG-IP VE](#deploy-the-big-ip-ve) from the command line.

### Edit the YAML file

After completing the prerequisites, edit the YAML file.  You must replace the following parameters with the appropriate values:

| Parameter | Description |
| --- | --- |
| region | The Google region in which you want to deploy BIG-IP, for example **us-west1**. |
| availabilityZone1 | The availability zone where you want to deploy the BIG-IP VE instance, such as **us-west1-a**. |
| mgmtNetwork | Management network name to use. |
| mgmtSubnet | Management subnet of the network specified to use. |
| mgmtSubnetAddress | (Optional) Static IP address to use. Defaults to **DYNAMIC** for dynamic address provisioning. |
| restrictedSrcAddress | This field restricts management access to a specific network or address. Enter an IP address or address range in CIDR notation separated by a space, or 0.0.0.0/0 for all sources. |
| restrictedSrcAddressApp | This field restricts web application access (ports 80 and 443) to a specific network or address. Enter an IP address or address range in CIDR notation separated by a space, or 0.0.0.0/0 for all sources. |
| network1 | Specify the Network name for BIG-IP application traffic.|
| subnet1 | Subnet of the Network BIG-IP should use for application traffic. |
| subnet1Address | (Optional) Static IP address to use. Defaults to **DYNAMIC** for dynamic address provisioning. |
| imageName | The F5 image name that is accessible by the project launching the deployment template. |
| instanceType | The BIG-IP instance type you want to use, such as **n1-standard-2** |
| mgmtGuiPort | (Optional) BIG-IP management port.  The default is **8443** |
| applicationPort | (Optional) List application port(s) separated by a space. Defaults to **80 and 443** |
| ntpServer | (Optional) List NTP servers separated by a space. Defaults to **time.google.com** |
| timezone | (Optional) Enter the Olson timezone string from /usr/share/zoneinfo ** Defaults to **UTC**|
| serviceAccount | (Optional) If using service discovery, enter the Google service account to use for discovery. |
| tagName | (Optional) If using service discovery, enter the tag name used on servers for discovery. |
| tagValue | (Optional) If using service discovery, enter the tag value used on servers for discovery. |
| allowUsageAnalytics | This deployment can send anonymous statistics to F5 to help us determine how to improve our solutions. If you enter **No** statistics are not sent. |

### Save the YAML and Python files

After you have edited the YAML file with the appropriate values, save the YAML file in a location accessible from the gcloud command line.  Save the [python file](https://github.com/F5Networks/f5-google-gdm-templates/blob/master/supported/standalone/2nic/existing-stack/payg/f5-existing-stack-payg-2nic-bigip.py) in the same location.

### Deploy the BIG-IP VE

The final task is to deploy the BIG-IP VE from the **gcloud** command line.  See https://cloud.google.com/sdk/gcloud/reference/deployment-manager/deployments/create for specific information.  

You can either create a new deployment from the [top-level YAML file](#deploying-from-the-yaml-file), or the [top-level template file](#deploying-from-the-template-file).

#### Deploying from the YAML file
To deploy the BIG-IP VE from the top-level YAML file, use the following command syntax:

```gcloud deployment-manager deployments create <your-deployment-name> --config <your-file-name.yaml> --description "<deployment-description>"```

Keep in mind the following:

- *your-deployment-name*<br>This name must be unique.<br>
- *your-file-name.yaml*<br>  If your file is not in the same directory as the Google SDK, include the full file path in the command.

#### Deploying from the template file
To deploy the BIG-IP VE from the top-level template file, use the following syntax, and set each property key you are using:

```gcloud deployment-manager deployments create <your-deployment-name>       \
            --template template.{jinja|py}             \
      --properties "string-key:'string-value',integer-key:12345"```


{% include 'SERVICE_DISCOVERY.jt2' with context %}


## Security Details <a name="securitydetail"></a>

This section has the entire code snippet for each of the lines you should ensure are present in your template file if you want to verify the integrity of the helper code in the template.

### /config/verifyHash section

Note the hashes and script-signature may be different in your template. The important thing to check is that there is a script-signature line present in the location.<br>


```python

  'cli script /Common/verifyHash {',
        'proc script::run {} {',
        '        if {[catch {',
        '            set hashes(f5-cloud-libs.tar.gz) a1de46685e31463e6c103078797b90e5f29a4b94702b0522eef2364c3792414067a0bea50c4ed49784c14277a578d8b41f9ac7ba058d9ff72ef687034e5119c6',
        '            set hashes(f5-cloud-libs-aws.tar.gz) d0803e306c01bdf82895c8f30f3b3c2df5f76edbe1875c0ffbfea6864436ece54a73ffd02ccd1b889c324b093897702087b722f10cc7f87994f518f81d7260ea',
        '            set hashes(f5-cloud-libs-azure.tar.gz) a1f264a165b88c03f55d49afb4fdb5f63d80755f1afe947a02e4a36755c7fcec432495417d8084329c6c14e4c426c2e63bab92862afb760d63f584a570b119e6',
        '            set hashes(f5-cloud-libs-gce.tar.gz) c01b25f4d6f48d9ac21b1a6ba3553c978e4fb8ce8655947a307f27e67833c4bebf8b72fef108ea02e11b5e9aa35d33e39db8624b3db34de509d0d79959c754c7',
        '            set hashes(f5-cloud-libs-openstack.tar.gz) 5c83fe6a93a6fceb5a2e8437b5ed8cc9faf4c1621bfc9e6a0779f6c2137b45eab8ae0e7ed745c8cf821b9371245ca29749ca0b7e5663949d77496b8728f4b0f9',
        '            set hashes(asm-policy-linux.tar.gz) 63b5c2a51ca09c43bd89af3773bbab87c71a6e7f6ad9410b229b4e0a1c483d46f1a9fff39d9944041b02ee9260724027414de592e99f4c2475415323e18a72e0',
        '            set hashes(f5.http.v1.2.0rc4.tmpl) 47c19a83ebfc7bd1e9e9c35f3424945ef8694aa437eedd17b6a387788d4db1396fefe445199b497064d76967b0d50238154190ca0bd73941298fc257df4dc034',
        '            set hashes(f5.http.v1.2.0rc6.tmpl) 811b14bffaab5ed0365f0106bb5ce5e4ec22385655ea3ac04de2a39bd9944f51e3714619dae7ca43662c956b5212228858f0592672a2579d4a87769186e2cbfe',
        '            set hashes(f5.http.v1.2.0rc7.tmpl) 21f413342e9a7a281a0f0e1301e745aa86af21a697d2e6fdc21dd279734936631e92f34bf1c2d2504c201f56ccd75c5c13baa2fe7653213689ec3c9e27dff77d',
        '            set hashes(f5.aws_advanced_ha.v1.3.0rc1.tmpl) 9e55149c010c1d395abdae3c3d2cb83ec13d31ed39424695e88680cf3ed5a013d626b326711d3d40ef2df46b72d414b4cb8e4f445ea0738dcbd25c4c843ac39d',
        '            set hashes(f5.aws_advanced_ha.v1.4.0rc1.tmpl) de068455257412a949f1eadccaee8506347e04fd69bfb645001b76f200127668e4a06be2bbb94e10fefc215cfc3665b07945e6d733cbe1a4fa1b88e881590396',
        '            set hashes(f5.aws_advanced_ha.v1.4.0rc2.tmpl) 6ab0bffc426df7d31913f9a474b1a07860435e366b07d77b32064acfb2952c1f207beaed77013a15e44d80d74f3253e7cf9fbbe12a90ec7128de6facd097d68f',
        '            set hashes(f5.aws_advanced_ha.v1.4.0rc3.tmpl) 2f2339b4bc3a23c9cfd42aae2a6de39ba0658366f25985de2ea53410a745f0f18eedc491b20f4a8dba8db48970096e2efdca7b8efffa1a83a78e5aadf218b134',
        '            set hashes(asm-policy.tar.gz) 2d39ec60d006d05d8a1567a1d8aae722419e8b062ad77d6d9a31652971e5e67bc4043d81671ba2a8b12dd229ea46d205144f75374ed4cae58cefa8f9ab6533e6',
        '            set hashes(deploy_waf.sh) 1a3a3c6274ab08a7dc2cb73aedc8d2b2a23cd9e0eb06a2e1534b3632f250f1d897056f219d5b35d3eed1207026e89989f754840fd92969c515ae4d829214fb74',
        '            set hashes(f5.policy_creator.tmpl) 06539e08d115efafe55aa507ecb4e443e83bdb1f5825a9514954ef6ca56d240ed00c7b5d67bd8f67b815ee9dd46451984701d058c89dae2434c89715d375a620',
        '            set hashes(f5.service_discovery.tmpl) 7a4660468dffdc4f6d9aec4c1f9d22abfb3e484e7d6fe6a12fc9ab3eec3819dc34d133aea3cce4fdd87a0f4045069270061f2ea1ee7735922e4371592e498a0b',
        '            set hashes(f5.cloud_logger.v1.0.0.tmpl) a26d5c470e70b821621476bcfd0579dbc0964f6a54158bc6314fa1e2f63b23bf3f3eb43ade5081131c24e08579db2e1e574beb3f8d9789d28acb4f312fad8c3e',
        'NEW_LINE',
        '            set file_path [lindex $tmsh::argv 1]',
        '            set file_name [file tail $file_path]',
        'NEW_LINE',
        '            if {![info exists hashes($file_name)]} {',
        '                tmsh::log err "No hash found for $file_name"',
        '                exit 1',
        '            }',
        'NEW_LINE',
        '            set expected_hash $hashes($file_name)',
        '            set computed_hash [lindex [exec /usr/bin/openssl dgst -r -sha512 $file_path] 0]',
        '            if { $expected_hash eq $computed_hash } {',
        '                exit 0',
        '            }',
        '            tmsh::log err "Hash does not match for $file_path"',
        '            exit 1',
        '        }]} {',
        '            tmsh::log err {Unexpected error in verifyHash}',
        '            exit 1',
        '        }',
        '    }',
        '    script-signature jJpTQ0bcHm9SypZSOPeKaHoUKRdTyLbz80xHYXy39dWx76geCGT5otZi4SdqGBiiwKFydQTqSVu+Uzj8TQZGg2fbxKg/Ks28Ht+nvLoTiNwZGY5o+iPse45QvltBvE+aCOIaw8a5ZBd5ZMF7A8JQpTwttUFRjFgXFu9CncAWOTypov46ve9dzRW8dRPbAImaJSby38jUIVWjv2iB3qZHz//bXjdZ5qUpFvpPH5dGzYN5SoQmUVI3kbiOpZlRJcSj8cKzQ7EsQozile5JkzPrzUeeMgOHihAZcOzgvYWl2LYe9iedixzF7ci6d4YNUuUhFfyrlrUOZSMUPtRzM3+rYQ==',
        '    signing-key /Common/f5-irule',

```

## Filing Issues

If you find an issue, we would love to hear about it.
You have a choice when it comes to filing issues:

- Use the **Issues** link on the GitHub menu bar in this repository for items such as enhancement or feature requests and non-urgent bug fixes. Tell us as much as you can about what you found and how you found it.
- Contact us at [solutionsfeedback@f5.com](mailto:solutionsfeedback@f5.com?subject=GitHub%20Feedback) for general feedback or enhancement requests.
- Use our [Slack channel](https://f5cloudsolutions.herokuapp.com) for discussion and assistance on F5 cloud templates. There are F5 employees who are members of this community who typically monitor the channel Monday-Friday 9-5 PST and will offer best-effort assistance.
- For templates in the **supported** directory, contact F5 Technical support via your typical method for more time sensitive changes and other issues requiring immediate support.

{% endblock info %}

{% block warning %}{% endblock warning%}
{% block matrix %}{% endblock matrix %}
{% block special %}{% endblock special %}
{% block supported %}{% endblock supported %}
